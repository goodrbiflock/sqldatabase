SELECT
customer_name,
avg(unit_price)
from(
with channel as(
  SELECT
    order_id id,
    value channel
 FROM public.fact_netsuite_order_custom_fields 
 where field_id = 1628
 )
  SELECT 
    customer_name,
    ord.transaction_id,
    channel,
    convert_timezone('UTC','America/Los_Angeles',ord."timestamp") as converted_timestamp,
		prod.name,
		prod.item_id,
		items.quantity,
		items.amount pre_discount,
		case 
		  when ord.discount is not NULL and ord.subtotal !=0
		  then items.amount+((items.amount/ord.subtotal)*ord.discount)
		  else items.amount
		  end as discounted_amount,
		discounted_amount/items.quantity as unit_price
 FROM public.fact_netsuite_orders ord
 left outer join public.fact_netsuite_order_items items on items.order_id = ord.order_id
 left outer join public.fact_netsuite_products prod on prod.product_id = items.order_item_id
 left outer join channel on channel.id=ord.order_id
 where ord.type = 'SalesOrder' 
  and channel='Key Account'
  and converted_timestamp > '2022-01-01 00:00:00'
  and discounted_amount>0
)
group by customer_name